# Stage 0
FROM maven:3.9.5-eclipse-temurin-21-alpine AS builder

ENV PASSPORT_HOME /usr/local/passport
RUN mkdir -p "$PASSPORT_HOME"
WORKDIR $PASSPORT_HOME

COPY . ./

# Build without running the unit and integration tests
RUN mvn package -Pxtest

# Stage 1
FROM eclipse-temurin:21-jre

# Dependencies for headless Chrome
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl unzip jq \
    fonts-liberation \
    libasound2t64 libatk-bridge2.0-0 libatk1.0-0 libc6 libcairo2 libcups2 \
    libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libglib2.0-0 libgtk-3-0 \
    libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 \
    libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 \
    libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \
 && rm -rf /var/lib/apt/lists/*

# Chrome for Testing - Required by Jvppeteer version 3.x
RUN set -eux; \
  mkdir -p /opt/cft; \
  URL=""; \
  # Try JSON
  if curl -fsSL https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json -o /tmp/cft.json; then \
    URL="$(jq -r '.channels.Stable.downloads.chrome[] | select(.platform=="linux64") | .url' /tmp/cft.json | head -n1 || true)"; \
  fi; \
  # Fallback: use LATEST_RELEASE_STABLE and build the GS URL
  if [ -z "${URL}" ] || ! curl -fsSL "${URL}" -o /tmp/chrome.zip; then \
    VER="$(curl -fsSL https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE)"; \
    URL="https://storage.googleapis.com/chrome-for-testing-public/${VER}/linux64/chrome-linux64.zip"; \
    curl -fsSL "${URL}" -o /tmp/chrome.zip; \
  fi; \
  unzip -q /tmp/chrome.zip -d /opt/cft; \
  ln -sf /opt/cft/chrome-linux64/chrome /usr/local/bin/chrome; \
  rm -rf /tmp/*

ENV PDF_EXECUTABLE_PATH=/usr/local/bin/chrome
ENV PASSPORT_HOME=/usr/local/passport
RUN mkdir -p "$PASSPORT_HOME"
WORKDIR $PASSPORT_HOME

COPY --from=builder $PASSPORT_HOME/target/passport-2.5.1.jar .

COPY docker/deployment/docker-entrypoint.sh .

RUN chmod +x docker-entrypoint.sh

ENTRYPOINT ["./docker-entrypoint.sh"]
